<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë‚ ì§œ ê³„ì‚°ê¸° & ë°”ì½”ë“œ ìƒì„±ê¸° (FINAL - OCR ì•ˆì •í™”)</title>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
/* (CSS ì½”ë“œëŠ” ì›ë³¸ê³¼ ë™ì¼) */
:root{
Â  --bg:#f6f8fb; --card:#fff; --accent:#1976d2; --danger:#d32f2f; --muted:#eef2f6; --soft:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial;background:var(--bg);color:#111}
.container{max-width:980px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-size:20px;font-weight:700}
.tabbar{display:flex;gap:8px;margin-top:12px}
.tab{padding:10px 14px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--soft);cursor:pointer;font-weight:700}
.tab.active{background:linear-gradient(90deg,var(--accent),#0b79d0);color:white;box-shadow:0 8px 24px rgba(11,121,208,0.12)}
.card{background:var(--card);border-radius:12px;padding:16px;margin-top:14px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.input, input[type="date"], input[type="number"], input[type="text"], select, textarea{
Â  width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:white;font-size:14px
}
.row{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:#eef2f7;color:#0b1220}
.small{font-size:13px;color:var(--soft)}
.preview-area{width:100%;height:260px;background:var(--muted);border-radius:10px;border:1px dashed #dfe7f3;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.preview-area img{width:100%;height:100%;object-fit:contain;display:block}
.placeholder{color:var(--soft);font-size:15px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.preset-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.preset-box{background:#fafafa;padding:10px;border-radius:8px;border:1px solid #ebf0f8;display:flex;flex-direction:column;gap:8px}
.preset-row{display:flex;align-items:center;gap:8px;width:100%}
.list{margin-top:12px}
.list-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;border:1px solid #eef2f7;background:white;margin-top:8px}
.thumb{width:110px;height:70px;overflow:hidden;border-radius:6px;border:1px solid #eee;display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}
.item-body{flex:1}
.item-actions{display:flex;flex-direction:column;gap:6px}
.status{margin-top:8px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff;color:#073763}
.footer{margin-top:18px;text-align:center;color:var(--soft);font-size:13px}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#eff6ff;color:#0b63b7;font-weight:700;font-size:13px}

/* responsive */
@media(max-width:760px){
Â  .grid{grid-template-columns:1fr}
Â  .preset-grid{grid-template-columns:repeat(2,1fr)}
Â  .thumb{width:80px;height:60px}
}
</style>
</head>
<body>
<div class="container">
Â  <div class="header">
Â  Â  <div>
Â  Â  Â  <div class="title">ë‚ ì§œ ê³„ì‚°ê¸° & ë°”ì½”ë“œ ìƒì„±ê¸°</div>
Â  Â  Â  <div class="small">Designed by TSKIM_QC</div>
Â  Â  </div>
Â  Â  <div class="badge">v1.2 (OCR ì•ˆì •í™” ì ìš©)</div>
Â  </div>

Â  <div class="tabbar" role="tablist" aria-label="tabs">
Â  Â  <button class="tab active" data-tab="dateTab">ğŸ“… ë‚ ì§œ ê³„ì‚°ê¸°</button>
Â  Â  <button class="tab" data-tab="barcodeTab">ğŸ“· ë°”ì½”ë“œ ìƒì„±ê¸°</button>
Â  </div>

Â  Â  <div id="dateTab" class="card" role="tabpanel">
Â  Â  <h3 style="margin:0 0 8px">ë‚ ì§œ ê³„ì‚°ê¸°</h3>

Â  Â  <div class="grid" aria-label="date-inputs">
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="small">ê¸°ì¤€ ë‚ ì§œ (ë…„/ì›”/ì¼)</label>
Â  Â  Â  Â  <input id="baseDate" type="date" class="input">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  <label class="small">ì§ì ‘ ê°€ê° ì…ë ¥ (ë…„, ì›”, ì¼)</label>
Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  <input id="years" type="number" class="input" placeholder="ë…„ìˆ˜ (ì˜ˆ: 0)">
Â  Â  Â  Â  Â  <input id="months" type="number" class="input" placeholder="ì›”ìˆ˜ (ì˜ˆ: 0)">
Â  Â  Â  Â  Â  <input id="days" type="number" class="input" placeholder="ì¼ìˆ˜ (ì˜ˆ: 0)">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
Â  Â  Â  <button id="addBtn" class="btn" style="background:var(--accent)">+ ë”í•˜ê¸° ëª¨ë“œ</button>
Â  Â  Â  <button id="subBtn" class="btn ghost" style="background:#fff;color:#ef4444;border:1px solid #efb4b4">- ë¹¼ê¸° ëª¨ë“œ</button>
Â  Â  Â  <label style="margin-left:8px;display:flex;align-items:center;gap:6px" title="ê¸°ì¤€ì¼ í¬í•¨ ì˜µì…˜">
Â  Â  Â  Â  <input id="includeBase" type="checkbox"> ê¸°ì¤€ ë‚ ì§œ í¬í•¨ (ê³„ì‚°ì‹œ ë³´ì •)
Â  Â  Â  </label>
Â  Â  </div>

Â  Â  <div style="margin-top:12px">
Â  Â  Â  <label class="small">ê³ ì • í”„ë¦¬ì…‹ (ì¼ìˆ˜) â€” 3 x 2 (ì²´í¬ë°•ìŠ¤ëŠ” ë‹¨ì¼ ì„ íƒ)</label>
Â  Â  Â  <div class="preset-grid" id="presetGrid">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  <button id="presetToggle" class="btn ghost" style="background:#64748b;color:#fff">í”„ë¦¬ì…‹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°</button>
Â  Â  Â  Â  <button id="calcBtn" class="btn" style="margin-left:auto;background:#10b981">ê³„ì‚°í•˜ê¸°</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
Â  Â  Â  <div style="flex:1;min-width:220px">
Â  Â  Â  Â  <label class="small">ë§ì¼ í™•ì¸ (ë³„ë„ ê¸°ëŠ¥)</label>
Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  <input id="lastYear" type="number" class="input" placeholder="ë…„ (ì˜ˆ: 2025)">
Â  Â  Â  Â  Â  <input id="lastMonth" type="number" class="input" placeholder="ì›” (1-12)">
Â  Â  Â  Â  Â  <button id="lastDayBtn" class="btn ghost" style="background:#e6eefb;color:#0b3a66">ë§ì¼ ë³´ê¸°</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1;min-width:200px">
Â  Â  Â  Â  <div class="status" id="calcResult" aria-live="polite">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="barcodeTab" class="card" role="tabpanel" style="display:none">
Â  Â  <h3 style="margin:0 0 8px">ë°”ì½”ë“œ ìƒì„±ê¸° & ì¸ì‹ê¸° (ZXing + Tesseract, OCR ì•ˆì •í™” ì ìš©)</h3>
Â  Â  <div class="small">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ $\text{ZXing}$ìœ¼ë¡œ ë°”ì½”ë“œë¥¼, $\text{Tesseract}$ë¡œ ì•„ë˜ ë¬¸ì($\text{eng+kor}$ í¬í•¨)ë¥¼ **ì›ë³¸ í•´ìƒë„**ë¡œ íŒë…í•˜ì—¬ ìµœì ì˜ ê²°ê³¼ë¥¼ ì°¾ìŠµë‹ˆë‹¤.</div>

Â  Â  <div class="preview-area" id="previewArea" style="margin-top:12px">
Â  Â  Â  <span class="placeholder" id="placeholderText">ë¶ˆëŸ¬ì˜¨ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
Â  Â  Â  <img id="preview" alt="">
Â  Â  </div>

Â  Â  <div style="text-align:center;margin-top:10px">
Â  Â  Â  <input id="fileInput" type="file" accept="image/*" style="display:none" onchange="onFileChange(event)">
Â  Â  Â  <button class="btn" onclick="document.getElementById('fileInput').click()">ê°¤ëŸ¬ë¦¬ ì—´ê¸°</button>
Â  Â  </div>

Â  Â  <div class="controls" style="margin-top:12px">
Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  <label class="small">ZXing ì¸ì‹ ê²°ê³¼</label>
Â  Â  Â  Â  <div id="autoResult" class="small">-</div>
Â  Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1"> 
Â  Â  Â  Â  <label class="small">OCR ì¸ì‹ ê²°ê³¼ (ì •ì œëœ ì½”ë“œ)</label>
Â  Â  Â  Â  <div id="ocrResult" class="small">-</div>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:2">
Â  Â  Â  Â  <label class="small">ìµœì¢… ë°”ì½”ë“œ (ìë™ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥)</label>
Â  Â  Â  Â  <input id="finalCode" class="input" type="text" placeholder="ìë™ ì±„ì›€ ë˜ëŠ” ì§ì ‘ ì…ë ¥">
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="controls" style="margin-top:10px">
Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  <label class="small">ì—…ì²´ëª…</label>
Â  Â  Â  Â  <input id="companyName" class="input" type="text" placeholder="ì—…ì²´ëª… ì…ë ¥">
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;flex-direction:column;gap:8px">
Â  Â  Â  Â  <button class="btn" onclick="createFromManual()">ì§ì ‘ ìƒì„±</button>
Â  Â  Â  Â  <button class="btn" onclick="downloadGenerated()" style="background:#06b6d4">ìƒì„± ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  </div>

Â  Â  <div style="margin-top:12px">
Â  Â  Â  <div id="progressLog" class="small" style="margin-top:6px"></div>
Â  Â  </div>

Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  <button class="btn" onclick="retryRecognize()">ë‹¤ì‹œ ì¸ì‹</button>
Â  Â  Â  <button class="btn ghost" onclick="clearPreview()">ì´ˆê¸°í™”</button>
Â  Â  Â  <button class="btn" onclick="saveEntry()" style="background:#10b981">ì €ì¥ (ì´ë¯¸ì§€+ë²ˆí˜¸+ì—…ì²´ëª…)</button>
Â  Â  </div>

Â  Â  <div class="list" id="list"></div>
Â  </div>

Â  <div class="footer">Â© TSKIM_QC</div>
</div>

<canvas id="processingCanvas" style="display:none"></canvas>
<canvas id="barcodeCanvas" style="display:none"></canvas>

<script>
/* ---------------- Tab switching (ì „í™˜ ì˜¤ë¥˜ ìˆ˜ì •) ---------------- */
document.querySelectorAll('.tab').forEach(btn=>{
Â  btn.addEventListener('click', ()=> {
Â  Â  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
Â  Â  btn.classList.add('active');
Â  Â  const target = btn.getAttribute('data-tab');
Â  Â  document.querySelectorAll('[role="tabpanel"]').forEach(panel=>{
Â  Â  Â  // ìˆ˜ì •ëœ ë¶€ë¶„: 'block'ìœ¼ë¡œ ëª…ì‹œí•˜ì—¬ ì „í™˜ì´ í™•ì‹¤í•˜ê²Œ ë˜ë„ë¡ í•¨
Â  Â  Â  panel.style.display = (panel.id === target) ? 'block' : 'none'; 
Â  Â  });
Â  Â  if(target === 'barcodeTab'){
Â  Â  Â  if(!document.getElementById('preview').src) document.getElementById('placeholderText').style.display='block';
Â  Â  }
Â  });
});

/* ---------------- Date calc logic (ì›ë³¸ê³¼ ë™ì¼) ---------------- */
const addBtn = document.getElementById('addBtn');
const subBtn = document.getElementById('subBtn');
let mode = 'add';
addBtn.addEventListener('click', ()=> {
Â  mode='add';
Â  addBtn.style.background='var(--accent)';
Â  addBtn.style.color='#fff';
Â  subBtn.style.background='#fff';
Â  subBtn.style.color='#ef4444';
});
subBtn.addEventListener('click', ()=> {
Â  mode='sub';
Â  subBtn.style.background='linear-gradient(90deg,#ef4444,#ef6b6b)';
Â  subBtn.style.color='#fff';
Â  addBtn.style.background='#fff';
Â  addBtn.style.color='#111';
});

/* presets (3x2) single-select behavior */
const presetGrid = document.getElementById('presetGrid');
for(let i=0;i<6;i++){
Â  const box = document.createElement('div');
Â  box.className='preset-box';
Â  box.innerHTML = `
Â  Â  <div style="width:100%;display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  <div style="font-weight:700">í”„ë¦¬ì…‹ ${i+1}</div>
Â  Â  Â  <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="preset-check" data-index="${i}"></label>
Â  Â  </div>
Â  Â  <div style="width:100%" class="preset-row">
Â  Â  Â  <input type="number" class="preset-input input" placeholder="ì¼ìˆ˜ (ì˜ˆ: 7)" />
Â  Â  </div>
Â  `;
Â  presetGrid.appendChild(box);
}
/* ensure only one checkbox can be selected at a time */
presetGrid.addEventListener('change', (e)=>{
Â  if(e.target && e.target.classList.contains('preset-check')){
Â  Â  const checks = Array.from(document.querySelectorAll('.preset-check'));
Â  Â  const idx = e.target.dataset.index;
Â  Â  if(e.target.checked){
Â  Â  Â  checks.forEach(c=>{ if(c !== e.target) c.checked = false; });
Â  Â  }
Â  }
});

/* preset toggle button */
const presetToggle = document.getElementById('presetToggle');
presetToggle.addEventListener('click', ()=> {
Â  const visible = presetGrid.style.display !== 'none';
Â  presetGrid.style.display = visible ? 'none' : 'grid';
});

/* calc button (ì›ë³¸ê³¼ ë™ì¼) */
const calcBtn = document.getElementById('calcBtn');
const calcResult = document.getElementById('calcResult');
calcBtn.addEventListener('click', ()=> {
Â  const baseVal = document.getElementById('baseDate').value;
Â  if(!baseVal){ calcResult.textContent = 'ê¸°ì¤€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'; return; }
Â  let d = new Date(baseVal + 'T00:00:00');
Â  // apply years/months/day inputs (years/months affect month/year first)
Â  const years = parseInt(document.getElementById('years').value) || 0;
Â  const months = parseInt(document.getElementById('months').value) || 0;
Â  const daysInput = parseInt(document.getElementById('days').value) || 0;
Â  
Â  const factor = (mode==='add' ? 1 : -1);
Â  if(years) d.setFullYear(d.getFullYear() + (factor * years));
Â  if(months) d.setMonth(d.getMonth() + (factor * months));
Â  
Â  // check presets - single selected only
Â  const checks = document.querySelectorAll('.preset-check');
Â  const inputs = document.querySelectorAll('.preset-input');
Â  let presetValue = 0;
Â  checks.forEach((chk, i)=>{
Â  Â  if(chk.checked){
Â  Â  Â  const v = parseInt(inputs[i].value) || 0;
Â  Â  Â  presetValue = v;
Â  Â  }
Â  });
Â  
Â  // validation: if daysInput and presetValue both empty/zero and years/months zero -> require at least one
Â  if(years === 0 && months === 0 && daysInput === 0 && presetValue === 0){
Â  Â  calcResult.textContent = 'ê°€ê°í•  ê°’(ë…„/ì›”/ì¼ ë˜ëŠ” í”„ë¦¬ì…‹)ì„ ì…ë ¥ ë˜ëŠ” ì„ íƒí•´ ì£¼ì„¸ìš”.';
Â  Â  return;
Â  }
Â  
Â  // compute total days: daysInput + presetValue (both are days)
Â  let totalDays = (daysInput || 0) + (presetValue || 0);
Â  
Â  // ê°€ê° ëª¨ë“œ ì ìš©
Â  if(mode === 'sub'){
Â  Â  totalDays = -totalDays; // ë¹¼ê¸° ëª¨ë“œì¼ ê²½ìš° ìŒìˆ˜ ì ìš©
Â  }
Â  
Â  // ë‚ ì§œì— ê°€ê° ì¼ìˆ˜ ì ìš©
Â  d.setDate(d.getDate() + totalDays);

Â  // includeBase: if checked, adjust based on mode
Â  const includeBase = document.getElementById('includeBase').checked;
Â  if(includeBase){
Â  Â  if(mode === 'add'){
Â  Â  Â  d.setDate(d.getDate() - 1); // ë”í•˜ê¸° ëª¨ë“œì¼ ë•Œ -1ì¼ ë³´ì • (ì‹œì‘ì¼ í¬í•¨)
Â  Â  } else if(mode === 'sub'){
Â  Â  Â  d.setDate(d.getDate() + 1); // ë¹¼ê¸° ëª¨ë“œì¼ ë•Œ +1ì¼ ë³´ì • (ì‹œì‘ì¼ í¬í•¨)
Â  Â  }
Â  }
Â  
Â  const weekday = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
Â  calcResult.textContent = `ê²°ê³¼ ë‚ ì§œ: ${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${weekday})`;
});

/* last day (independent) */
const lastDayBtn = document.getElementById('lastDayBtn');
lastDayBtn.addEventListener('click', ()=> {
Â  const y = parseInt(document.getElementById('lastYear').value);
Â  const m = parseInt(document.getElementById('lastMonth').value);
Â  if(isNaN(y) || isNaN(m) || m < 1 || m > 12){ calcResult.textContent = 'ì—°ë„ì™€ 1-12 ë²”ìœ„ì˜ ì›”ì„ ì…ë ¥í•˜ì„¸ìš”.'; return; }
Â  const last = new Date(y, m, 0).getDate();
Â  calcResult.textContent = `${y}ë…„ ${m}ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œëŠ” ${last}ì¼ì…ë‹ˆë‹¤.`;
});

/* ---------------- Barcode (ZXing + Tesseract) logic - ì•ˆì •í™”ëœ ë¡œì§ ì ìš© ---------------- */
const preview = document.getElementById('preview');
const placeholderText = document.getElementById('placeholderText');
const fileInput = document.getElementById('fileInput');
const processingCanvas = document.getElementById('processingCanvas');
const processingCtx = processingCanvas.getContext('2d');
const barcodeCanvas = document.getElementById('barcodeCanvas');
const autoResultEl = document.getElementById('autoResult');
const ocrResultEl = document.getElementById('ocrResult');
const finalCodeEl = document.getElementById('finalCode');
const companyEl = document.getElementById('companyName');
const progressLog = document.getElementById('progressLog');

let saved = JSON.parse(localStorage.getItem('barcode_saved_vfinal_stable') || '[]');
// localStorage í‚¤ë¥¼ ë³€ê²½í•˜ì—¬ ì´ì „ ëª©ë¡ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

/* ZXing setup */
const hints = new Map();
hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
Â  ZXing.BarcodeFormat.CODE_128,
Â  ZXing.BarcodeFormat.CODE_39,
Â  ZXing.BarcodeFormat.EAN_13,
Â  ZXing.BarcodeFormat.UPC_A,
Â  ZXing.BarcodeFormat.QR_CODE
]);
const reader = new ZXing.BrowserMultiFormatReader(hints);


/* file input handler */
async function onFileChange(e){
Â  const file = e.target.files[0];
Â  if(!file) return;
Â  const url = URL.createObjectURL(file);
Â  preview.src = url;
Â  preview.style.display = 'block';
Â  placeholderText.style.display = 'none';
Â  autoResultEl.textContent = '-'; ocrResultEl.textContent = '-'; finalCodeEl.value = '';
Â  await new Promise(res => preview.onload = res);
Â  // draw on canvas as-is (ì›ë³¸ í•´ìƒë„ ì ìš©)
Â  processingCanvas.width = preview.naturalWidth; 
Â  processingCanvas.height = preview.naturalHeight;
Â  processingCtx.drawImage(preview,0,0);
Â  // run recognition pipeline (ZXing + OCR)
Â  await recognizePipeline();
}

/* ì¸ì‹ íŒŒì´í”„ë¼ì¸ (ë“€ì–¼ ì¸ì‹/ë¹„êµ ë¡œì§ ì‚¬ìš© + OCR í•„í„°ë§ ê°œì„ ) */
async function recognizePipeline(){
Â  autoResultEl.textContent='-'; ocrResultEl.textContent='-'; finalCodeEl.value='';
Â  
Â  let zxingText = '';
Â  let ocrText = ''; // ìµœì¢… ì½”ë“œì— ì‚¬ìš©ë  ì •ì œëœ OCR ê°’
Â  
Â  // ADDED: ì›ë³¸ í•´ìƒë„ ì²˜ë¦¬ í™•ì¸ ë¡œê·¸
Â  progressLog.textContent = `ì›ë³¸ ì´ë¯¸ì§€ (${processingCanvas.width}x${processingCanvas.height}px) ì¸ì‹ ì‹œì‘...`; 
Â  
Â  // 1. ZXing ë°”ì½”ë“œ íŒ¨í„´ ì¸ì‹
Â  try{
Â  Â  const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(processingCanvas);
Â  Â  const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
Â  Â  const result = reader.decode(binaryBitmap);
Â  Â  zxingText = result && result.getText ? result.getText().trim() : '';
Â  Â  autoResultEl.textContent = zxingText || 'ì¸ì‹ ì‹¤íŒ¨';
Â  }catch(e){
Â  Â  console.warn('ZXing no result', e);
Â  Â  autoResultEl.textContent = 'ì¸ì‹ ì‹¤íŒ¨';
Â  }

Â  // 2. Tesseract OCR ë¬¸ì ì¸ì‹ (ì•ˆì •í™”ëœ ë°©ì‹ ì ìš©)
Â  progressLog.textContent = 'Tesseract OCR ë¬¸ì ì¸ì‹ ì‹œì‘... (eng+kor, ì•ˆì •í™” ëª¨ë“œ)';
Â  let rawOcrText = '';
Â  let cleanedOcrText = '';
Â  try{
Â  Â  // Tesseract.recognize ì§ì ‘ í˜¸ì¶œ (ì´ì „ ì„±ê³µ ë¡œì§)
Â  Â  const result = await Tesseract.recognize(processingCanvas, 'eng+kor', { 
Â  Â  Â  Â  logger: m => {
Â  Â  Â  Â  Â  Â  if(m.status) progressLog.textContent = `OCR ì§„í–‰ ìƒí™©: ${m.status} (${Math.round(m.progress * 100)}%)`;
Â  Â  Â  Â  } 
Â  Â  });
Â  Â  rawOcrText = result.data.text.trim();
Â  Â  
Â  Â  // OCR ê²°ê³¼ í•„í„°ë§ ê°œì„  (ë°”ì½”ë“œ/ì½”ë“œì— ìµœì í™”ëœ í•„í„°: ìˆ«ì, ì˜ë¬¸, í•˜ì´í”ˆë§Œ ë‚¨ê¸°ê³  ê³µë°± ì œê±°)
Â  Â  cleanedOcrText = rawOcrText
Â  Â  Â  Â  .replace(/[\n\r]/g, ' ') 
Â  Â  Â  Â  .replace(/[^0-9A-Za-z\- ]/g, '') // ìˆ«ì, ì˜ë¬¸, í•˜ì´í”ˆ, ê³µë°±ë§Œ í—ˆìš©
Â  Â  Â  Â  .replace(/\s+/g,'') // ëª¨ë“  ê³µë°± ì œê±°
Â  Â  Â  Â  .trim();
Â  Â  
Â  Â  ocrResultEl.textContent = cleanedOcrText || rawOcrText || 'ì¸ì‹ ì‹¤íŒ¨';
Â  Â  ocrText = cleanedOcrText; // ìµœì¢… ë°”ì½”ë“œ ë¹„êµì—ëŠ” ì½”ë“œë¡œ ì •ì œëœ ê°’ ì‚¬ìš©
Â  }catch(e){
Â  Â  console.error('Tesseract failed', e);
Â  Â  ocrResultEl.textContent = 'ì¸ì‹ ì‹¤íŒ¨';
Â  }

Â  // 3. ìµœì¢… ê²°ê³¼ ê²°ì • ë¡œì§ (ë“€ì–¼ ì¸ì‹ ë¡œì§ ì‚¬ìš©: ZXing ìš°ì„ , ì‹¤íŒ¨ ì‹œ OCR ì‚¬ìš©)
Â  let finalCode = '';
Â  if(zxingText && zxingText !== 'ì¸ì‹ ì‹¤íŒ¨'){
Â  Â  finalCode = zxingText;
Â  Â  progressLog.textContent = `âœ… $\text{ZXing}$ ë°”ì½”ë“œ ì¸ì‹ ì„±ê³µ (${finalCode})`;
Â  } else if (ocrText && ocrText !== 'ì¸ì‹ ì‹¤íŒ¨'){
Â  Â  finalCode = ocrText;
Â  Â  progressLog.textContent = `âœ… $\text{OCR}$ ë¬¸ì ì¸ì‹ ì„±ê³µ (${finalCode})`;
Â  }
Â  
Â  finalCodeEl.value = finalCode;
Â  if (!finalCode) {
Â  Â  progressLog.textContent = 'âŒ ë°”ì½”ë“œ/ë¬¸ì ì¸ì‹ ì‹¤íŒ¨ â€” ìˆ˜ë™ ì…ë ¥ í•„ìš”';
Â  }
Â  
Â  renderList();
}

/* Manual create & download (ì›ë³¸ê³¼ ë™ì¼) */
function createFromManual(){
Â  const val = finalCodeEl.value.trim();
Â  if(!val) return alert('ìƒì„±í•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
Â  JsBarcode(barcodeCanvas, val, { format: "CODE128", displayValue: true, fontSize:14, width:2, height:60 });
Â  const dataUrl = barcodeCanvas.toDataURL('image/png');
Â  preview.src = dataUrl;
Â  progressLog.textContent = 'ë°”ì½”ë“œ ìƒì„± ì™„ë£Œ';
}
function downloadGenerated(){
Â  const val = finalCodeEl.value.trim();
Â  if(!val) return alert('ë‹¤ìš´ë¡œë“œí•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
Â  JsBarcode(barcodeCanvas, val, { format: "CODE128", displayValue: true, fontSize:14, width:2, height:60 });
Â  const url = barcodeCanvas.toDataURL('image/png');
Â  const a = document.createElement('a');
Â  a.href = url; a.download = `barcode_${val}.png`; document.body.appendChild(a); a.click(); a.remove();
}

/* Save / list / per-item download & delete (ì›ë³¸ê³¼ ë™ì¼) */
function saveEntry(){
Â  const code = finalCodeEl.value.trim();
Â  const comp = companyEl.value.trim();
Â  const img = preview.src || '';
Â  if(!code) return alert('ìµœì¢… ë°”ì½”ë“œ ë²ˆí˜¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
Â  if(!comp) return alert('ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
Â  const item = { id:'id'+Date.now(), code, comp, img };
Â  saved.unshift(item);
Â  localStorage.setItem('barcode_saved_vfinal_stable', JSON.stringify(saved));
Â  renderList();
Â  clearPreview();
Â  progressLog.textContent = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
}
function renderList(){
Â  const list = document.getElementById('list');
Â  list.innerHTML = '';
Â  if(!saved.length){
Â  Â  list.innerHTML = '<div class="small" style="padding:10px;color:var(--soft)">ì €ì¥ëœ ë°”ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  return;
Â  }
Â  saved.forEach(it=>{
Â  Â  const div = document.createElement('div'); div.className='list-item';
Â  Â  div.innerHTML = `<div class="thumb"><img src="${it.img}" alt=""></div>
Â  Â  Â  <div class="item-body"><div><b>ì—…ì²´:</b> ${escapeHtml(it.comp)}</div><div style="margin-top:6px"><b>ì½”ë“œ:</b> ${escapeHtml(it.code)}</div></div>
Â  Â  Â  <div class="item-actions"><button class="btn" onclick="downloadItem('${it.id}')">ë‹¤ìš´ë¡œë“œ</button><button class="btn ghost" onclick="deleteItem('${it.id}')">ì‚­ì œ</button></div>`;
Â  Â  list.appendChild(div);
Â  });
}
function downloadItem(id){
Â  const it = saved.find(x=>x.id===id);
Â  if(!it) return alert('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
Â  const a = document.createElement('a');
Â  a.href = it.img;
Â  a.download = `barcode_${it.code}.png`;
Â  document.body.appendChild(a);
Â  a.click();
Â  a.remove();
}
function deleteItem(id){
Â  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
Â  saved = saved.filter(x=>x.id !== id);
Â  localStorage.setItem('barcode_saved_vfinal_stable', JSON.stringify(saved));
Â  renderList();
}
function downloadAllBarcodes(){
Â  if(!saved.length) return alert('ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
Â  (async ()=>{
Â  Â  for(const it of saved){
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = it.img;
Â  Â  Â  a.download = `barcode_${it.code}.png`;
Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  a.click();
Â  Â  Â  a.remove();
Â  Â  Â  await new Promise(r=>setTimeout(r,200));
Â  Â  }
Â  })();
}

/* helpers */
function clearPreview(){ preview.src=''; document.getElementById('fileInput').value=''; placeholderText.style.display='block'; autoResultEl.textContent='-'; ocrResultEl.textContent='-'; finalCodeEl.value=''; companyEl.value=''; progressLog.textContent=''; }
function retryRecognize(){ if(preview.src) recognizePipeline(); }
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* init */
renderList();

</script>
</body>
</html>